{% extends "staffs/base.html" %}
{% load django_bootstrap5 %}
{% load crispy_forms_tags %}
{% load crispy_forms_field %}

{% block main %}
<h2>利用者一覧</h2>
<div class="my-5 text-end">
    <div class="row">
        <a href="{% url 'schedules:import' %}"><button type="button" class="btn btn-primary">全利用者分を{{ month }}月の予定に反映</button></a>
    </div>
    <div class="row mt-3">
        <a href="{% url 'schedules:import_next' %}"><button type="button" class="btn btn-primary">全利用者分を{{ next_month }}月の予定に反映</button></a>
    </div>
</div>

<div class="my-5"><a href="{% url 'careusers:new' %}">{% bootstrap_button button_type="button" content="利用者新規登録" %}</a></div>

{% if object_list %}
<table class="table table-sm align-middle text-center">
    <thead>
        <tr>
            <th>ID</th>
            <th>利用者名</th>
            <th>追加</th>
            <th colspan='3'>標準スケジュール</th>
            <th>サービス可能スタッフ</th>
            <th>備考</th>
            <th>変更</th>
            <th>追加</th>
        </tr>
    </thead>
    <tbody>
    {% for careuser in object_list %}
        <tr>
            {% if careuser.defaultschedule_set.all|length > 0 and careuser.is_active %}
            <td rowspan="{{ careuser.defaultschedule_set.all|length }}">{{careuser.id}}</td>
            <td rowspan="{{ careuser.defaultschedule_set.all|length }}"><a href="{% url 'careusers:edit' careuser.id %}">{{careuser.last_name}} {{careuser.first_name}}</a></td>
            <td rowspan="{{ careuser.defaultschedule_set.all|length }}"><a href="{% url 'careusers:def_sche_new' careuser.id %}">{% bootstrap_button button_type="button" content="追加" %}</a></td>
            {% else %}
            <td>{{careuser.id}}</td>
            <td><a href="{% url 'careusers:edit' careuser.id %}">{{careuser.last_name}} {{careuser.first_name}}</a></td>
            <td><a href="{% url 'careusers:def_sche_new' careuser.id %}">{% bootstrap_button button_type="button" content="追加" %}</a></td>
            {% endif %}
            {% if careuser.is_active %}
            {% if careuser.defaultschedule_set.all|length > 0 %}
                {% for sche in careuser.defaultschedule_set.all %}
                    {% if forloop.first == False %}
                    <tr>
                    {% endif %}
                        <td>{{ sche.get_schedule_name }}</td>
                        <td>{{ sche.get_start_time }}{{sche.get_end_time }}</td>
                        <td>{{ sche.service }}{% if sche.peoples > 1 %}　×　{{ sche.peoples }}名{% endif %}</td>
                        <td>{{ sche.get_schedule_staffs }}</td>
                        <td>{{ sche.biko }}</td>
                        <td><a href="{% url 'careusers:def_sche_edit' sche.pk %}">{% bootstrap_button button_type="button" content="変更" %}</a></td>
                        <td><a class="btn btn-danger" href="{% url 'careusers:def_sche_delete' sche.pk %}"> 削除</a></td>
                        {% if forloop.first == False %}
                    </tr> 
                    {% endif %}
                {% endfor %}
            {% else %}
                <td colspan="7"></td>
            {% endif %}
            {% else %}
                <td colspan="7">利用停止中</td>
            {% endif %}
            </td>
        </tr>
    {% endfor %}
    </tbody>
</table>
{% else %}
<p>利用者は登録されておりません。</p>
{% endif %}
{% endblock %}